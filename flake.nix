# Update with 'nix run github:cargo2nix/cargo2nix'
{
  inputs = {
    cargo2nix.url = "github:cargo2nix/cargo2nix/release-0.11.0";
    flake-utils.follows = "cargo2nix/flake-utils";
    nixpkgs.follows = "cargo2nix/nixpkgs";
    devshell.url = "github:numtide/devshell";
  };

  outputs = { self, cargo2nix, nixpkgs, flake-utils, devshell }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        logo = ''
          [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;5;1;7m [0m[38;2;119;34;159mâ–ˆ[0m[38;2;169;48;225mâ–ˆ[0m[38;2;161;46;214mâ–ˆ[0m[38;2;87;25;116mâ–ˆ[0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
          [0m[38;2;8;9;16mâ–ˆ[0m[38;2;50;57;97mâ–ˆ[0m[38;2;63;71;121mâ–ˆ[0m[38;2;59;66;113mâ–ˆ[0m[38;2;32;36;62mâ–ˆ[0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;111;31;149mâ–ˆ[0m[38;2;170;48;228mâ–ˆ[0m[38;2;170;48;228mâ–ˆ[0m[38;2;170;48;228mâ–ˆ[0m[38;2;170;48;228mâ–ˆ[0m[38;2;97;27;131mâ–ˆ[0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
          [0m[38;2;86;97;166mâ–ˆ[0m[38;2;104;117;200mâ–ˆ[0m[38;2;104;116;200mâ–ˆ[0m[38;2;104;116;200mâ–ˆ[0m[38;2;105;116;200mâ–ˆ[0m[38;2;68;73;129mâ–ˆ[0m[38;2;2;2;3m [0m[38;2;38;38;38m [0m[38;2;82;82;82m [0m[38;2;100;24;146mâ–ˆ[0m[38;2;141;33;207mâ–ˆ[0m[38;2;156;37;230mâ–ˆ[0m[38;2;159;38;233mâ–ˆ[0m[38;2;120;28;179mâ–ˆ[0m[38;2;61;13;94mâ–ˆ[0m[38;2;32;6;49mâ–ˆ[0m[38;2;27;5;41mâ–ˆ[0m[38;2;32;7;50mâ–ˆ[0m[38;2;13;3;20mâ–ˆ[0m[38;2;0;0;0m [0m
          [0m[38;2;47;47;47m [0m[38;2;95;95;95m [0m[38;2;109;109;109m [0m[38;2;104;104;104m [0m[38;2;105;105;105m [0m[38;2;87;76;158mâ–ˆ[0m[38;2;101;85;183mâ–ˆ[0m[38;2;62;47;110mâ–ˆ[0m[38;2;46;33;80mâ–ˆ[0m[38;2;50;32;86mâ–ˆ[0m[38;2;52;31;89mâ–ˆ[0m[38;2;40;21;67mâ–ˆ[0m[38;2;5;1;7m [0m[38;2;49;49;49m [0m[38;2;119;18;201mâ–ˆ[0m[38;2;142;22;239mâ–ˆ[0m[38;2;142;22;239mâ–ˆ[0m[38;2;142;22;239mâ–ˆ[0m[38;2;141;21;239mâ–ˆ[0m[38;2;97;14;167mâ–ˆ[0m
          [0m[38;2;0;0;0m [0m[38;2;1;0;2m [0m[38;2;35;7;70mâ–ˆ[0m[38;2;50;10;99mâ–ˆ[0m[38;2;42;9;84mâ–ˆ[0m[38;2;15;7;28mâ–ˆ[0m[38;2;46;46;46m [0m[38;2;68;34;112mâ–ˆ[0m[38;2;134;64;220mâ–ˆ[0m[38;2;135;62;221mâ–ˆ[0m[38;2;136;60;222mâ–ˆ[0m[38;2;137;59;222mâ–ˆ[0m[38;2;111;44;179mâ–ˆ[0m[38;2;2;2;2m [0m[38;2;25;25;25m [0m[38;2;70;7;128mâ–ˆ[0m[38;2;132;12;243mâ–ˆ[0m[38;2;132;12;243mâ–ˆ[0m[38;2;132;12;243mâ–ˆ[0m[38;2;29;3;53m [0m {bold}
          [0m[38;2;3;3;3m [0m[38;2;101;20;210mâ–ˆ[0m[38;2;117;23;243mâ–ˆ[0m[38;2;117;23;243mâ–ˆ[0m[38;2;117;23;243mâ–ˆ[0m[38;2;114;22;236mâ–ˆ[0m[38;2;36;7;75mâ–ˆ[0m[38;2;19;19;19m [0m[38;2;26;9;42m [0m[38;2;142;49;226mâ–ˆ[0m[38;2;142;49;226mâ–ˆ[0m[38;2;115;40;184mâ–ˆ[0m[38;2;66;66;66m [0m[38;2;1;1;1m [0m[38;2;0;0;0m [0m[38;2;6;6;6m [0m[38;2;24;24;24m [0m[38;2;28;28;28m [0m[38;2;20;20;20m [0m[38;2;2;2;2m [0m
          [0m[38;2;1;1;1m [0m[38;2;49;49;49m [0m[38;2;78;14;171mâ–ˆ[0m[38;2;112;20;245mâ–ˆ[0m[38;2;112;20;245mâ–ˆ[0m[38;2;112;20;245mâ–ˆ[0m[38;2;111;20;243mâ–ˆ[0m[38;2;67;12;148mâ–ˆ[0m[38;2;26;5;58mâ–ˆ[0m[38;2;35;11;62mâ–ˆ[0m[38;2;40;13;68mâ–ˆ[0m[38;2;15;5;26mâ–ˆ[0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
          [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;6;6;6m [0m[38;2;13;13;13m [0m[38;2;11;11;11m [0m[38;2;13;13;13m [0m[38;2;27;27;27m [0m[38;2;1;0;3m [0m[38;2;106;17;246mâ–ˆ[0m[38;2;106;17;246mâ–ˆ[0m[38;2;106;17;246mâ–ˆ[0m[38;2;106;17;246mâ–ˆ[0m[38;2;91;15;213mâ–ˆ[0m[38;2;33;5;78mâ–ˆ[0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
          [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;2;0;4m [0m[38;2;101;14;248mâ–ˆ[0m[38;2;101;14;248mâ–ˆ[0m[38;2;101;14;248mâ–ˆ[0m[38;2;101;14;248mâ–ˆ[0m[38;2;25;4;60m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
          [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;35;35;35m [0m[38;2;37;5;94m [0m[38;2;62;8;158mâ–ˆ[0m[38;2;46;46;46m [0m[38;2;6;6;6m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m'';
        pkgs = import nixpkgs {
          inherit system;
          overlays = [ cargo2nix.overlays.default devshell.overlay ];
        };

        rustPkgs = pkgs.rustBuilder.makePackageSet {
          rustVersion = "1.61.0";
          packageFun = import ./Cargo.nix;
        };
        commonCategory = y: builtins.map (x: x // { category = y; });
      in rec {
        packages = {
          aiken = (rustPkgs.workspace.aiken { }).bin;
          default = packages.aiken;
        };
        devShell = pkgs.devshell.mkShell {
          # shell = (rustPkgs.workspace.aiken { }).bin;
          name = "aiken";
          motd = ''

            ${logo} {bold}AIKEN
                        $(type -p menu &>/dev/null && menu)'';
          commands = commonCategory "Rust Development" [
            {
              name = "rust-format-all";
              command = "cargo run --";
              help = "Formats all rust source code";
              package = packages.aiken;
            }
            {
              name = "uplc";
              command = "cargo run -- uplc";
              help = "Formats all rust source code";
              package = packages.aiken;
            }
          ] ++ commonCategory "Aiken Development" [
            {
              name = "aiken-fmt";
              command = "blah";
              help = "Formats all aiken source code";
              package = packages.aiken;
            }
            {
              name = "uplc";
              command = "blah";
              help = "Shorthand for aiken uplc";
              package = packages.aiken;
            }
          ];
        };
      });
}
